<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bitcoin Retirement Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ——— basic styling ——— */
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
        background: #fafafa;
        color: #333;
      }
      .input-summary-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap;
      }
      #inputArea,
      #summary {
        flex: 1;
        min-width: 300px;
      }
      select,
      input,
      button.update-button {
        margin-bottom: 10px;
        padding: 5px;
        width: 250px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button.update-button {
        width: auto;
        cursor: pointer;
        background: #4caf50;
        color: #fff;
      }
      label {
        display: inline-block;
        width: 350px;
        vertical-align: top;
        margin-bottom: 5px;
      }
      .tooltip-button {
        margin-left: 5px;
        color: darkorange;
        cursor: pointer;
        font-size: 1em;
        background: none;
        border: none;
        padding: 0;
      }
      .custom-tooltip {
        position: absolute;
        background: #333;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        z-index: 1000;
        max-width: 150px;
        word-wrap: break-word;
      }
      button {
        padding: 10px 20px;
        margin-top: 10px;
        border: none;
        border-radius: 4px;
        background: #4caf50;
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background: #45a049;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
        background: #fff;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px 10px;
        text-align: center;
      }
      th {
        background: #f0f0f0;
      }
      .summary-table {
        max-width: 500px;
        margin-top: 20px;
      }
      .retirement-table {
        width: 100%;
      }
      .summary-table td {
        text-align: left;
        padding: 6px;
      }
      .hint {
        font-size: 0.9em;
        color: #555;
      }
      .currency-label {
        font-weight: bold;
      }
      #retirementSummary {
        margin-top: 40px;
        max-width: none;
      }
      .warning {
        color: red;
        font-weight: bold;
        margin-bottom: 10px;
      }
      #chartContainer {
        margin-top: 20px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      #chartContainer canvas {
        flex: 1 1 350px;
        max-width: 100%;
        height: 200px !important;
      }
      #explanation {
        margin-bottom: 20px;
        padding: 10px;
        background: #e9f5ff;
        border: 1px solid #b3d7ff;
        border-radius: 4px;
      }
      #fxStamp {
        font-size: 0.8em;
        color: #777;
        margin-left: 10px;
      }
    </style>
    <script>
      /* ===== 1. FX helpers & price fetch ===== */
      let currentCurrency = "USD";
      const fxRates = { USD: 1 };

      function getLocaleForCurrency(c) {
        return c === "USD"
          ? "en-US"
          : c === "EUR"
          ? "de-DE"
          : c === "PLN"
          ? "pl-PL"
          : "en-US";
      }
      const convertFromUsd = (a, cur) => a * (fxRates[cur] ?? 1);
      const convertToUsd = (a, cur) => a / (fxRates[cur] ?? 1);
      function formatCurrency(n) {
        return (
          parseFloat(n).toLocaleString(getLocaleForCurrency(currentCurrency), {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }) +
          " " +
          currentCurrency
        );
      }

      function stampFx() {
        fxRates.__updated = new Date().toLocaleString(
          getLocaleForCurrency("USD")
        );
        document.getElementById("fxStamp").textContent =
          "FX updated: " + fxRates.__updated;
      }

      async function updateFxRates() {
        const fallback = { USD: 1, EUR: 0.93, PLN: 4 };
        const setRates = (o) => {
          fxRates.USD = 1;
          fxRates.EUR = o.EUR;
          fxRates.PLN = o.PLN;
          stampFx();
        };
        try {
          const r = await fetch(
            "https://api.exchangerate.host/latest?base=USD&symbols=EUR,PLN"
          );
          if (r.ok) {
            setRates((await r.json()).rates);
            return;
          }
        } catch {}
        try {
          const r = await fetch("https://open.er-api.com/v6/latest/USD");
          if (r.ok) {
            const d = await r.json();
            setRates({ EUR: d.rates.EUR, PLN: d.rates.PLN });
            return;
          }
        } catch {}
        Object.assign(fxRates, fallback);
        stampFx();
      }

      async function updatePrice() {
        try {
          if (!fxRates.EUR) await updateFxRates();
          const r = await fetch(
            "https://api.coinbase.com/v2/prices/spot?currency=USD"
          );
          if (!r.ok) throw new Error();
          const priceUsd = parseFloat((await r.json()).data.amount);
          const price =
            currentCurrency === "USD"
              ? priceUsd
              : convertFromUsd(priceUsd, currentCurrency);
          const inp = document.getElementById("currentPrice");
          if (inp) inp.value = Math.round(price);
        } catch (e) {
          console.error(e);
        }
      }
      function updateCurrencyLabels() {
        document
          .querySelectorAll(".currency-label")
          .forEach((el) => (el.textContent = currentCurrency));
      }

      /* ===== 2. DOM ready ===== */
      document.addEventListener("DOMContentLoaded", async () => {
        const curSel = document.getElementById("currencySelect");
        await updateFxRates();
        currentCurrency = curSel.value;
        updateCurrencyLabels();
        await updatePrice();

        document.querySelectorAll(".usd-input").forEach((i) =>
          i.addEventListener("input", function () {
            if (this.value < 0) this.value = 0;
          })
        );
        curSel.addEventListener("change", async () => {
          currentCurrency = curSel.value;
          updateCurrencyLabels();
          await updatePrice();
        });
        document
          .getElementById("updatePriceButton")
          .addEventListener("click", async () => {
            await updateFxRates();
            await updatePrice();
          });
      });

      /* ===== 3. Core calculator ===== */
      function calculate() {
        /* clear old output */
        document.getElementById("resultBody").innerHTML = "";
        document.getElementById("summary").innerHTML = "";
        document.getElementById("retirementSummary").innerHTML = "";

        /* create chart container */
        const rDiv = document.getElementById("retirementSummary");
        const chCont = document.createElement("div");
        chCont.id = "chartContainer";
        const cv1 = document.createElement("canvas");
        cv1.id = "retirementChart";
        const cv2 = document.createElement("canvas");
        cv2.id = "btcChart";
        chCont.appendChild(cv1);
        chCont.appendChild(cv2);
        rDiv.appendChild(chCont);

        /* gather inputs */
        const getF = (id) => parseFloat(document.getElementById(id).value);
        const getI = (id) => parseInt(document.getElementById(id).value, 10);
        const [
          currentPrice,
          expectedCAGR,
          yearlyCAGRChange,
          initialAllocation,
          monthlyPurchase,
          monthlyPurchaseChange,
          years,
        ] = [
          "currentPrice",
          "expectedCAGR",
          "yearlyCAGRChange",
          "initialAllocation",
          "monthlyPurchase",
          "monthlyPurchaseChange",
          "years",
        ]
          .map((id) => document.getElementById(id).value)
          .map(Number);
        if (
          [
            currentPrice,
            expectedCAGR,
            yearlyCAGRChange,
            initialAllocation,
            monthlyPurchase,
            monthlyPurchaseChange,
            years,
          ].some(isNaN)
        ) {
          alert("Please fill the accumulation inputs");
          return;
        }

        /* ----- accumulation loop ----- */
        let price = currentPrice,
          cCAGR = expectedCAGR,
          curMonthly = monthlyPurchase,
          totalBTC = 0,
          totalInvested = 0;
        const btc0 = initialAllocation / price;
        totalBTC += btc0;
        totalInvested += initialAllocation;
        addRow(
          0,
          price,
          btc0,
          btc0 * price,
          "-",
          "-",
          "Year 0 uses initial lump sum"
        );
        for (let y = 1; y <= years; y++) {
          const start = price,
            end = start * (1 + cCAGR / 100),
            avg = (start + end) / 2,
            invest = curMonthly * 12,
            btc = invest / avg,
            val = btc * end;
          totalBTC += btc;
          totalInvested += invest;
          addRow(
            y,
            start,
            btc,
            val,
            cCAGR.toFixed(2),
            curMonthly,
            "Year " + y + ": monthly purchases use avg price"
          );
          price = end;
          cCAGR *= 1 - yearlyCAGRChange / 100;
          curMonthly *= 1 + monthlyPurchaseChange / 100;
        }
        const finalValue = totalBTC * price,
          netGain = finalValue - totalInvested,
          pctGain = (netGain / totalInvested) * 100;
        createSummaryTable(
          totalInvested,
          totalBTC,
          price,
          finalValue,
          netGain,
          pctGain
        );

        /* retirement inputs */
        const desiredPension = getF("desiredPension"),
          pensionChange = getF("pensionChange"),
          retYears = getI("retirementYears");
        if ([desiredPension, pensionChange, retYears].some(isNaN)) {
          alert("Fill retirement inputs");
          return;
        }

        const retireData = simulateRetirement(
          totalBTC, // start BTC stack
          price, // BTC price at retirement start
          desiredPension,
          pensionChange,
          cCAGR, // CAGR enters retirement already decayed
          yearlyCAGRChange,
          retYears
        );
        createRetirementTable(retireData);
        createRetirementCharts(retireData);
      }
      window.calculate = calculate; /* expose for onclick */

      /* ===== 4. Helper functions ===== */
      function addRow(year, price, btc, val, cagr, monthly, tips) {
        const tb = document.getElementById("resultBody"),
          tr = document.createElement("tr");
        const put = (v) => {
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        };
        put(year);
        const mcap = Math.floor(
          (convertToUsd(price, currentCurrency) * 21e6) / 1e12
        );
        put(formatCurrency(price) + " (" + mcap + " T USD)");
        put(btc.toFixed(8));
        put(formatCurrency(val));
        put(cagr);
        put(typeof monthly === "number" ? formatCurrency(monthly) : monthly);
        tr.title = tips;
        tb.appendChild(tr);
      }

      function createSummaryTable(inv, btc, price, val, net, pct) {
        const d = document.getElementById("summary");
        const h = document.createElement("h2");
        h.textContent = "Accumulation Summary";
        d.appendChild(h);
        const t = document.createElement("table");
        t.className = "summary-table";
        const b = document.createElement("tbody");
        const row = (l, v) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${l}</td><td>${v}</td>`;
          b.appendChild(tr);
        };
        row("Total Invested:", formatCurrency(inv));
        row("Total Bitcoin Purchased (BTC):", btc.toFixed(8));
        row("Final Bitcoin Price:", formatCurrency(price));
        row("Final Investment Value:", formatCurrency(val));
        row("Net Gain:", formatCurrency(net));
        row("Percentage Gain (%):", pct.toFixed(0));
        t.appendChild(b);
        d.appendChild(t);
      }

      /* ===== 5. NEW retirement simulation that actually sells BTC ===== */
      function simulateRetirement(
        startBTC, // BTC stack at retirement start
        btcPriceStart, // BTC price at retirement start
        initialMonthly, // starting pension
        pensionChange, // % change per year
        startCAGR, // CAGR in year 1
        yearlyCAGRChange, // CAGR decay
        retirementYears
      ) {
        let btcHold = startBTC;
        let price = btcPriceStart;
        let monthly = initialMonthly;
        let CAGR = startCAGR;
        const out = [];

        for (let yr = 1; yr <= retirementYears; yr++) {
          const priceEnd = price * (1 + CAGR / 100);
          const avgPrice = (price + priceEnd) / 2; // rough average price
          const btcSold = (monthly * 12) / avgPrice; // coins required for cash
          const startPort = btcHold * price;

          btcHold = Math.max(0, btcHold - btcSold); // reduce holdings
          const endPort = btcHold * priceEnd;

          out.push({
            year: yr,
            bitcoinPrice: price,
            startingPortfolio: startPort,
            currentCAGR: CAGR,
            monthlyPension: monthly,
            totalWithdrawal: monthly * 12,
            annualGrowth: endPort - startPort + monthly * 12,
            endingPortfolio: endPort,
            remainingBTC: btcHold,
          });

          /* advance one year */
          monthly *= 1 + pensionChange / 100;
          CAGR *= 1 - yearlyCAGRChange / 100;
          price = priceEnd;
        }
        return out;
      }

      /* ===== 6. Table & chart rendering ===== */
      function createRetirementTable(arr) {
        const div = document.getElementById("retirementSummary");
        const warn = arr.find((d) => d.endingPortfolio <= 0);
        if (warn) {
          const p = document.createElement("p");
          p.className = "warning";
          p.textContent =
            "Warning: portfolio runs out after Year " + warn.year + ".";
          div.appendChild(p);
        }
        const h = document.createElement("h2");
        h.textContent = "Retirement Projection";
        div.appendChild(h);

        const tbl = document.createElement("table");
        tbl.className = "retirement-table";
        const headers = [
          "Year",
          "Bitcoin Price (" + currentCurrency + ") (Mkcap)",
          "Starting Portfolio (" + currentCurrency + ")",
          "Current CAGR (%)",
          "Monthly Pension (" + currentCurrency + ")",
          "Total Annual Withdrawal (" + currentCurrency + ")",
          "Annual Growth (" + currentCurrency + ")",
          "Withdrawal/Growth (%)",
          "Ending Portfolio (" + currentCurrency + ")",
          "Remaining Bitcoin (BTC)",
        ];
        const thead = document.createElement("thead"),
          hr = document.createElement("tr");
        headers.forEach((t) => {
          const th = document.createElement("th");
          th.textContent = t;
          hr.appendChild(th);
        });
        thead.appendChild(hr);
        tbl.appendChild(thead);

        const tbody = document.createElement("tbody");
        arr.forEach((d) => {
          const r = document.createElement("tr"),
            cell = (v) => {
              const td = document.createElement("td");
              td.textContent = v;
              r.appendChild(td);
            };
          cell(d.year);
          const mcap = Math.floor(
            (convertToUsd(d.bitcoinPrice, currentCurrency) * 21e6) / 1e12
          );
          cell(formatCurrency(d.bitcoinPrice) + " (" + mcap + " T USD)");
          cell(formatCurrency(d.startingPortfolio));
          cell(d.currentCAGR.toFixed(0));
          cell(formatCurrency(d.monthlyPension));
          cell(formatCurrency(d.totalWithdrawal));
          cell(formatCurrency(d.annualGrowth));
          cell(((d.totalWithdrawal / d.annualGrowth) * 100).toFixed(1) + "%");
          const endTd = document.createElement("td");
          endTd.textContent = formatCurrency(d.endingPortfolio);
          if (d.endingPortfolio < 0) {
            endTd.style.color = "red";
            endTd.style.fontWeight = "bold";
          }
          r.appendChild(endTd);
          cell(d.remainingBTC.toFixed(8));
          tbody.appendChild(r);
        });
        tbl.appendChild(tbody);
        div.appendChild(tbl);
      }

      function createRetirementCharts(arr) {
        const labels = arr.map((d) => "Year " + d.year),
          port = arr.map((d) => d.endingPortfolio),
          btc = arr.map((d) => d.remainingBTC);

        new Chart(document.getElementById("retirementChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Ending Portfolio (" + currentCurrency + ")",
                data: port,
                backgroundColor: "rgba(75,192,192,0.2)",
                borderColor: "rgba(75,192,192,1)",
                borderWidth: 2,
                fill: true,
                tension: 0.1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (v) =>
                    v.toLocaleString(getLocaleForCurrency(currentCurrency), {
                      maximumFractionDigits: 0,
                    }) +
                    " " +
                    currentCurrency,
                },
              },
            },
          },
        });

        new Chart(document.getElementById("btcChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Remaining Bitcoin (BTC)",
                data: btc,
                backgroundColor: "rgba(255,159,64,0.2)",
                borderColor: "rgba(255,159,64,1)",
                borderWidth: 2,
                fill: true,
                tension: 0.1,
              },
            ],
          },
          options: { scales: { y: { beginAtZero: true } } },
        });
      }
    </script>
  </head>
  <body>
    <h1>Bitcoin Retirement Calculator</h1>
    <div id="explanation">
      This app projects the growth of your Bitcoin holdings and simulates
      retirement withdrawals – dynamically converting between
      <span class="currency-label">USD</span>, EUR and PLN using live FX rates.
    </div>

    <!-- ===== Currency selector ===== -->
    <div>
      <label for="currencySelect">Select Currency:</label>
      <select id="currencySelect">
        <option value="USD" selected>USD</option>
        <option value="EUR">EUR</option>
        <option value="PLN">PLN</option>
      </select>
      <button type="button" id="updatePriceButton" class="update-button">
        Update Price
      </button>
      <span id="fxStamp"></span>
    </div>

    <!-- ===== Input + summary ===== -->
    <div class="input-summary-container">
      <div id="inputArea">
        <div>
          <label for="currentPrice"
            >Current Bitcoin Price (<span class="currency-label">USD</span
            >):</label
          ><input
            id="currentPrice"
            class="usd-input"
            type="number"
            step="any"
            min="1"
          />
        </div>
        <div>
          <label for="expectedCAGR"
            >Expected Future CAGR (%)
            <span class="hint">(hist 5‑yr 56%, 10‑yr 82%)</span></label
          ><input id="expectedCAGR" type="number" step="any" value="35" />
        </div>
        <div>
          <label for="yearlyCAGRChange">Yearly CAGR Change (%)</label
          ><input id="yearlyCAGRChange" type="number" step="any" value="5" />
        </div>
        <div>
          <label for="initialAllocation"
            >Initial Allocation (<span class="currency-label">USD</span
            >):</label
          ><input
            id="initialAllocation"
            class="usd-input"
            type="number"
            step="any"
            value="10000"
          />
        </div>
        <div>
          <label for="monthlyPurchase"
            >Monthly Purchase (<span class="currency-label">USD</span>):</label
          ><input
            id="monthlyPurchase"
            class="usd-input"
            type="number"
            step="any"
            value="1000"
          />
        </div>
        <div>
          <label for="monthlyPurchaseChange"
            >Yearly Change in Monthly Purchase (%)</label
          ><input
            id="monthlyPurchaseChange"
            type="number"
            step="any"
            value="0"
          />
        </div>
        <div>
          <label for="years">Number of Years to Invest:</label
          ><input id="years" type="number" step="1" value="5" />
        </div>

        <h3>Retirement Assumptions</h3>
        <div>
          <label for="desiredPension"
            >Desired Monthly Pension (<span class="currency-label">USD</span
            >):</label
          ><input
            id="desiredPension"
            class="usd-input"
            type="number"
            step="any"
            value="2000"
          />
        </div>
        <div>
          <label for="pensionChange">Yearly Change in Pension (%)</label
          ><input id="pensionChange" type="number" step="any" value="2" />
        </div>
        <div>
          <label for="retirementYears">Number of Retirement Years:</label
          ><input id="retirementYears" type="number" step="1" value="15" />
        </div>

        <button onclick="calculate()">Calculate</button>
      </div>
      <div id="summary"></div>
    </div>

    <!-- ===== Yearly breakdown table ===== -->
    <div id="result">
      <h2>Yearly Investment Breakdown</h2>
      <table id="resultTable">
        <thead>
          <tr>
            <th>Year</th>
            <th>
              Bitcoin Price (<span class="currency-label">USD</span>) (Mkcap)
            </th>
            <th>Bitcoin Purchased</th>
            <th>Value (<span class="currency-label">USD</span>)</th>
            <th>Current CAGR (%)</th>
            <th>Monthly Purchase (<span class="currency-label">USD</span>)</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>

    <!-- ===== Retirement projection ===== -->
    <div id="retirementSummary"></div>
  </body>
</html>
